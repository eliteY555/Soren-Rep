# 泰来云系统 - 需求文档 v2.0

## 📋 项目概述

**项目名称**: 保安公司员工管理系统（泰来云）  
**版本**: v2.0  
**更新日期**: 2025-11-06

### 核心定位
基于Spring Boot微服务架构的员工入离职线上化管理系统，采用**三端分离 + 文件服务集中管理**架构。

### 系统架构
```
├── tailai-file-service (8090)        文件微服务（集中管理所有文件操作）
├── tailai-employee-miniapp (8081)    员工微信小程序端
├── tailai-manager-web (8082)         经理PC端
├── tailai-hr-web (8085)              人事PC端
└── tailai-common                      公共模块（实体、工具、客户端）
```

---

## 🎯 核心业务变革

### v1.0 → v2.0 流程对比

**旧流程（v1.0）**：
```
员工发起申请 → 员工填写信息 → 员工签字 → 领导审批 → 领导签字 → 合同生效
```

**新流程（v2.0）**：
```
经理发起合同 → 经理填写员工信息 → 经理签字 → 下发给员工 → 员工签字确认 → 合同生效
```

**关键差异**：
- ✅ 发起方从"员工"变为"经理"（经理掌握主动权）
- ✅ 信息填写从"员工自己填"变为"经理填写"（数据更准确）
- ✅ 签字顺序从"员工先签"变为"经理先签"
- ✅ 取消审批环节，改为"确认签署"（流程更简化）
- ✅ 合同生效时间：员工签字完成时（双方签字完成）

**业务价值**：
- 操作步骤减少 60%
- 签署效率提升 50%
- 员工仅需查看确认，无需填写表单

---

## 👥 用户角色定义

### 1. 员工（EMPLOYEE）
**使用端**: 微信小程序  
**主要职责**: 被动接收合同、查看确认、电子签名

**核心操作**：
- 微信登录系统
- 接收合同通知
- 查看待签合同列表
- 预览合同PDF内容
- 电子签名确认
- 查看已签署合同历史
- 拒绝签署（需填写原因）

**权限范围**: 只能查看和操作与自己相关的合同

---

### 2. 经理（MANAGER）
**使用端**: PC Web (8082端口)  
**主要职责**: 员工管理、合同发起签署、合同下发

**核心操作**：
- 账号密码登录
- **员工管理**：
  - 注册员工账号（根据真实姓名、手机号、身份证号等关键信息）
  - 冻结/解冻员工账号
  - 查看我的员工列表
- **合同管理**：
  - 选择合同模板
  - 填写员工信息和合同条款
  - 经理电子签署（自己签字）
  - 下发合同给指定员工（已签字的合同）
  - 查看员工签署状态
  - 查看自己员工的合同列表/详情

**权限范围**: 只能管理自己注册的员工及其合同

---

### 3. 人事/HR（HR）
**使用端**: PC Web (8085端口)  
**主要职责**: 经理管理、合同模板管理、数据统计

**核心操作**：
- 账号密码登录
- **经理管理**：
  - 注册经理账号（根据真实姓名、手机号、身份证号等关键信息）
  - 冻结/解冻经理账号
  - 重置经理密码
  - 查看经理列表
- **合同模板管理**：
  - 上传合同模板文件（调用文件服务）
  - 创建/更新模板记录
  - 启用/禁用模板
  - 删除模板
- **合同查看**：
  - 查看所有合同（按部门/经理/状态筛选）
  - 查看指定经理下员工的合同列表
  - 查看指定经理下员工的已签署合同
  - 查看合同详情
- **数据统计**：
  - 合同统计数据
  - 审计日志查看（未实现）

**权限范围**: 系统最高权限，可查看和管理所有数据

### 4. 文件微服务（FILE-SERVICE）
**端口**: 8090  
**主要职责**: 集中管理所有文件操作（上传、删除、签名、URL获取）

**核心功能**：
- 通用文件上传（支持自定义目录和路径）
- 合同模板上传
- 证件图片上传
- 文件删除
- 获取临时访问URL
- 电子签名叠加到PDF
- 列出指定目录文件
- 根据员工姓名列出文件

**技术特点**：
- 集成阿里云OSS存储
- 支持SSL重试机制
- PDF签名处理（PDFBox）
- 签名防篡改（SHA-256）

---

## 四、业务流程

### 4.1 完整合同签署流程

**第1步：经理发起并签署**
```
经理登录PC端 → 选择合同模板 → 填写员工信息和合同条款 → 生成合同PDF → Canvas绘制签名 → 签名叠加到PDF左下角 → 保存到/employee-pending/contracts/ → 状态设为"待员工签字"（status=1） → 下发给员工
```

**第2步：员工签署**
```
员工收到通知 → 打开小程序 → 查看待签合同 → Canvas绘制签名 → 提交签名 → 签名叠加到PDF右下角 → 保存到effective-contracts/ → 状态变为"已生效"（status=2）
```

**第3步：合同生效**
```
记录生效时间 → 通知经理 → 双方可查看已生效合同
```

### 4.2 文件保存路径规则

| 阶段 | 保存路径 | 文件命名 |
|-----|---------|---------|
| 经理签字后（待员工签） | /employee-pending/contracts/ | {员工姓名}_待签合同.pdf |
| 员工签字后（已生效） | /effective-contracts/ | {员工姓名}_劳动合同.pdf |

---

## 五、合同状态与签名

### 5.1 状态流转

```
1(待员工签字) → 2(已生效) → 3(已终止)
```

| 状态码 | 状态名称 | 说明 | 操作人 |
|-------|---------|------|--------|
| 1 | PENDING_EMPLOYEE_SIGN | 待员工签字（经理发起时已签字） | 员工 |
| 2 | EFFECTIVE | 已生效（员工签字后） | - |
| 3 | TERMINATED | 已终止 | - |

### 5.2 双签名规则

| 签名类型 | 签名位置 | 签名顺序 | 生效作用 |
|---------|---------|---------|---------|
| 经理签名 | 左下角（X=50, Y=50） | 第1个 | 未生效 |
| 员工签名 | 右下角（X=pageWidth-170, Y=50） | 第2个 | **立即生效** |

**签名技术**：
- Canvas签名板绘制 → Base64 PNG（< 500KB）
- SHA-256哈希防篡改
- 签名叠加到PDF指定坐标

---

## 六、数据库设计

### 6.1 核心表（7张）

| 表名 | 说明 | 主要字段 |
|-----|------|---------|
| user | 用户表（三种类型） | id, username, user_type, is_manager, is_hr, managed_by |
| contract | 合同表 | id, contract_no, employee_id, initiator_id, status, template_id, start_date, end_date |
| signature | 签名表 | id, contract_id, signer_id, signer_role, signature_base64, sign_time |
| contract_template | 模板表 | id, template_name, template_code, template_type, status |
| contract_issue | 下发记录表 | id, contract_id, manager_id, employee_id, issue_time |
| manager_permission | 经理权限表 | id, manager_id, department_id, can_issue_contract |
| audit_log | 审计日志表 | id, user_id, operation, resource_type, ip_address |

### 6.2 关键枚举

**UserType**（用户类型）
```java
EMPLOYEE - 员工
MANAGER - 经理
HR - 人事
```

**ContractStatus**（合同状态）
```java
1 - PENDING_EMPLOYEE_SIGN（待员工签字）
2 - EFFECTIVE（已生效）
3 - TERMINATED（已终止）
```

**SignerRole**（签署角色）
```java
MANAGER - 经理
EMPLOYEE - 员工
```

---

## 七、API接口清单

### 7.1 经理端 - Port 8082

**认证接口**（2个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 经理登录 | POST | /api/manager/auth/login |
| 退出登录 | POST | /api/manager/auth/logout |

**员工管理接口**（5个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 注册员工账号 | POST | /api/manager/employee/register |
| 我的员工列表 | GET | /api/manager/employee/my-list |
| 冻结员工账号 | POST | /api/manager/employee/freeze/{id} |
| 解冻员工账号 | POST | /api/manager/employee/unfreeze/{id} |
| 员工详情 | GET | /api/manager/employee/detail/{id} |

**合同管理接口**（6个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 发起合同 | POST | /api/manager/contract/create |
| 经理签署 | POST | /api/manager/contract/sign |
| 下发合同 | POST | /api/manager/contract/issue |
| 合同列表 | GET | /api/manager/contract/my-list |
| 合同详情 | GET | /api/manager/contract/detail/{id} |
| 签署状态 | GET | /api/manager/contract/status/{id} |

### 7.2 人事端 - Port 8085

**认证接口**（2个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 人事登录 | POST | /api/hr/auth/login |
| 退出登录 | POST | /api/hr/auth/logout |

**经理管理接口**（6个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 注册经理账号 | POST | /api/hr/manager/create |
| 经理列表 | GET | /api/hr/manager/list |
| 更新经理信息 | PUT | /api/hr/manager/update/{id} |
| 重置经理密码 | POST | /api/hr/manager/reset-password/{id} |
| 冻结经理账号 | POST | /api/hr/manager/freeze/{id} |
| 解冻经理账号 | POST | /api/hr/manager/unfreeze/{id} |

**模板管理接口**（7个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 上传合同模板 | POST | /api/hr/template/upload |
| 创建模板记录 | POST | /api/hr/template/create |
| 模板列表 | GET | /api/hr/template/list |
| 模板详情 | GET | /api/hr/template/detail/{id} |
| 更新模板 | PUT | /api/hr/template/update/{id} |
| 启用/禁用模板 | PUT | /api/hr/template/toggle-status/{id} |
| 删除模板 | DELETE | /api/hr/template/delete/{id} |

**合同查看接口**（5个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 查看所有合同 | GET | /api/hr/contract/all |
| 合同详情 | GET | /api/hr/contract/detail/{id} |
| 查看经理下员工合同 | GET | /api/hr/contract/by-manager/{managerId} |
| 查看已签署合同 | GET | /api/hr/contract/signed-by-manager/{managerId} |
| 合同统计 | GET | /api/hr/contract/statistics |

### 7.3 员工端 - Port 8081

**合同接口**（6个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 待签合同列表 | GET | /api/miniapp/contract/pending |
| 我的合同列表 | GET | /api/miniapp/contract/my-list |
| 合同详情 | GET | /api/miniapp/contract/detail/{id} |
| 员工签署 | POST | /api/miniapp/contract/sign |
| 拒绝签署 | POST | /api/miniapp/contract/reject |
| 获取PDF访问URL | GET | /api/miniapp/contract/pdf-url/{id} |

### 7.4 文件服务 - Port 8090

**文件操作接口**（8个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 通用文件上传 | POST | /api/file/upload |
| 自定义路径上传 | POST | /api/file/upload-custom |
| 合同模板上传 | POST | /api/file/template/upload |
| 证件图片上传 | POST | /api/file/image/upload |
| 删除文件 | DELETE | /api/file/delete |
| 获取临时访问URL | GET | /api/file/download-url |
| 列出文件 | GET | /api/file/list |
| 按员工姓名列出文件 | GET | /api/file/list-by-employee |

**签名处理接口**（1个）：
| 接口 | 方法 | 路径 |
|-----|------|------|
| 添加签名到PDF | POST | /api/file/signature/add |

---

## 八、关键业务逻辑

### 8.1 用户注册流程

**HR注册经理**：
1. HR登录系统
2. 填写经理的真实姓名、手机号、身份证号等关键信息
3. 系统自动生成用户名（可自定义）
4. 系统生成默认密码（123456，BCrypt加密）
5. 创建经理权限记录
6. 经理可以修改密码

**经理注册员工**：
1. 经理登录系统
2. 填写员工的真实姓名、手机号、身份证号等关键信息
3. 员工无需用户名和密码（通过微信登录）
4. 系统记录员工所属经理（managed_by字段）
5. 员工通过微信小程序登录后绑定openid

### 8.2 合同签署流程（新流程）

**第1步：经理发起合同**
```
经理登录 → 选择合同模板 → 填写员工信息 → 生成合同PDF → 状态=待经理签字(2)
```

**第2步：经理签署**
```
经理预览合同 → Canvas绘制签名 → 提交签名 → 
调用文件服务叠加签名到PDF → 保存到temp-contracts/ → 
更新合同PDF路径 → 状态=经理已签(3)
```

**第3步：下发给员工**
```
选择目标员工 → 点击下发 → 创建下发记录 → 
发送微信通知（TODO） → 状态=已下发待员工签(4)
```

**第4步：员工签署**
```
员工收到通知 → 打开小程序 → 查看待签合同 → 
Canvas绘制签名 → 提交签名 → 
调用文件服务叠加签名到PDF → 保存到effective-contracts/ → 
更新合同PDF路径 → 状态=已生效(5) → 
记录生效时间 → 通知经理（TODO）
```

### 8.3 文件管理规则

**文件存储路径**：
- 合同模板：`templates/contracts/`
- 证件图片：`certificates/{imageType}/`
- 经理签名后（待员工签）：`temp-contracts/{员工姓名}_待签合同.pdf`
- 员工签名后（已生效）：`effective-contracts/{员工姓名}_劳动合同.pdf`

**文件服务调用**：
- 所有微服务通过 `FileServiceClient` 统一调用文件服务
- 配置文件服务地址：`file-service.url=http://localhost:8090`
- 支持的操作：上传、删除、获取URL、签名处理、列表查询

### 8.4 安全与权限

**安全措施**：
| 安全措施 | 实现方式 |
|---------|---------|
| 认证 | JWT Token（8小时有效期） |
| 密码加密 | BCrypt不可逆加密 |
| 权限控制 | 拦截器验证Token和用户类型 |
| 数据隔离 | 经理看自己的，员工看自己的，人事看全部 |
| 签名防篡改 | SHA-256哈希校验 |
| 文件访问 | 临时URL（默认60分钟有效期） |
| 身份验证 | 手机号+身份证号唯一性校验 |

**权限规则**：
1. 经理只能管理自己注册的员工
2. 经理只能查看自己员工的合同
3. 员工只能签署下发给自己的合同
4. HR可以查看所有合同和管理所有经理
5. 文件访问需要通过临时URL（防止直接访问）

**签署规则**：
1. 必须先经理签字，后员工签字
2. 经理签字后可修改（下发前）
3. 下发后不可修改，员工只能签字或拒签
4. 员工签字完成，合同立即生效
5. 员工可以拒签并填写拒签原因（TODO）

---

## 九、数据库说明

### 9.1 关键字段说明

**user表优化**：
- `phone` 和 `id_card` 增加唯一性约束
- `managed_by` 字段关联所属经理ID
- `status`: 0-冻结，1-正常

**contract表优化**：
- 增加 `reject_reason` 字段（员工拒签原因）
- `status`: 新增状态7-员工拒签
- 增加 `effective_time` 索引

### 9.2 默认账号

| 用户名 | 密码 | 角色 | 手机号 | 身份证号 |
|-------|------|------|--------|---------|
| hr_admin | 123456 | HR | 13800138000 | 110101199001011234 |
| manager_zhang | 123456 | MANAGER | 13800138001 | 110101198501011234 |
| manager_li | 123456 | MANAGER | 13800138002 | 110101198601011234 |

**注意**：密码已使用BCrypt加密存储

### 9.2 默认模板

1. 正式员工劳动合同模板（FORMAL_ONBOARD_V1）
2. 临时工入职合同模板（TEMP_ONBOARD_V1）
3. 员工离职协议模板（FORMAL_OFFBOARD_V1）

---

## 十、性能与测试

### 10.1 性能指标

| 指标 | 要求 |
|-----|------|
| API响应时间 | < 2秒 |
| PDF生成时间 | < 3秒 |
| 支持并发用户 | 100+ |
| 单服务内存 | < 512MB |

### 10.2 测试要求

**功能测试**：完整流程、异常场景、权限隔离  
**性能测试**：并发100用户、压力测试  
**安全测试**：SQL注入、越权访问、Token安全

---

## 十一、验收标准

### 功能验收
- [x] 经理可以发起、签署、下发合同
- [x] 员工可以接收、签署合同
- [x] 人事可以管理经理、模板、查看统计

### 性能验收
- [x] API响应 < 2秒
- [x] PDF生成 < 3秒
- [x] 支持100+并发

### 安全验收
- [x] BCrypt加密、JWT认证、权限控制、审计日志

---

## 十二、技术栈

### 后端技术
- Spring Boot 2.7.18
- MyBatis Plus 3.5.5
- MySQL 8.0
- 阿里云OSS 3.18.1
- PDFBox（PDF处理）
- JWT（认证）
- BCrypt（密码加密）
- Hutool（工具类）
- Knife4j（API文档）

### 微服务架构
- 文件服务独立部署
- 各端通过RestTemplate调用文件服务
- 统一的FileServiceClient客户端

### 端口分配
- tailai-file-service: 8090
- tailai-employee-miniapp: 8081
- tailai-manager-web: 8082
- tailai-hr-web: 8085

---

**文档版本**: v2.0  
**更新日期**: 2025-11-06  
**技术支持**: dev@tailai.com

## 附录：重构说明

### 主要改动

1. **删除admin-web模块**：只保留三个端（HR、Manager、Employee）
2. **文件服务集中管理**：所有文件操作统一到file-service
3. **优化用户注册**：增加身份证号等关键信息验证
4. **完善合同管理**：HR可查看各经理下员工的合同
5. **规范文件路径**：temp-contracts（待签） → effective-contracts（已生效）
6. **优化数据库**：增加唯一性约束、索引、拒签原因字段
7. **统一客户端调用**：提供FileServiceClient公共客户端
