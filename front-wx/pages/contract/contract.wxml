<!--pages/contract/contract.wxml-->
<view class="contract-page">
  <!-- æ ‡ç­¾æ  -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 0 ? 'active' : ''}}" bindtap="switchTab" data-index="0">
      <view class="tab-text">å¾…ç­¾ç½²</view>
    </view>
    <view class="tab-item {{activeTab === 1 ? 'active' : ''}}" bindtap="switchTab" data-index="1">
      <view class="tab-text">å·²ç­¾ç½²</view>
    </view>
  </view>

  <!-- åˆåŒåˆ—è¡¨ -->
  <view class="contract-list">
    <view wx:if="{{loading}}" class="loading">
      <view class="loading-text">åŠ è½½ä¸­...</view>
    </view>

    <view wx:elif="{{contractList.length === 0}}" class="empty">
      <view class="empty-icon">ğŸ“„</view>
      <view class="empty-text">æš‚æ— åˆåŒ</view>
    </view>

    <view wx:else>
      <view class="contract-item" wx:for="{{contractList}}" wx:key="id" bindtap="viewContract" data-id="{{item.id}}">
        <view class="contract-header">
          <view class="contract-no">{{item.contractNo}}</view>
          <view class="contract-status {{getStatusClass(item.status)}}">
            {{getStatusText(item.status)}}
          </view>
        </view>
        
        <view class="contract-info">
          <view class="info-row">
            <view class="info-label">å‘˜å·¥å§“åï¼š</view>
            <view class="info-value">{{item.employeeName}}</view>
          </view>
          <view class="info-row">
            <view class="info-label">å²—ä½ï¼š</view>
            <view class="info-value">{{item.position}}</view>
          </view>
          <view class="info-row">
            <view class="info-label">åŸºæœ¬å·¥èµ„ï¼š</view>
            <view class="info-value">Â¥{{item.baseSalary}}</view>
          </view>
          <view class="info-row">
            <view class="info-label">åˆåŒæœŸé™ï¼š</view>
            <view class="info-value">{{item.startDate}} è‡³ {{item.endDate}}</view>
          </view>
        </view>
        
        <view class="contract-footer">
          <view class="create-time">åˆ›å»ºæ—¶é—´ï¼š{{formatDate(item.createdAt)}}</view>
          <view class="arrow">â€º</view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆåŒè¯¦æƒ…å¼¹çª— -->
  <view class="modal" wx:if="{{showDetailModal}}">
    <view class="modal-mask" catchtouchmove="preventTouchMove" bindtap="closeDetailModal"></view>
    <view class="modal-content" catchtouchmove="preventTouchMove">
      <view class="modal-header">
        <view class="modal-title">åˆåŒè¯¦æƒ…</view>
        <view class="modal-close" bindtap="closeDetailModal">âœ•</view>
      </view>

      <view class="modal-body" wx:if="{{currentContract}}">
        <view class="detail-section">
          <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
          <view class="detail-row">
            <view class="detail-label">åˆåŒç¼–å·ï¼š</view>
            <view class="detail-value">{{currentContract.contractNo}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">å‘˜å·¥å§“åï¼š</view>
            <view class="detail-value">{{currentContract.employeeName}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">å²—ä½ï¼š</view>
            <view class="detail-value">{{currentContract.position}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">åŸºæœ¬å·¥èµ„ï¼š</view>
            <view class="detail-value">Â¥{{currentContract.baseSalary}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">åˆåŒå¼€å§‹æ—¥æœŸï¼š</view>
            <view class="detail-value">{{currentContract.startDate}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">åˆåŒç»“æŸæ—¥æœŸï¼š</view>
            <view class="detail-value">{{currentContract.endDate}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">åˆåŒçŠ¶æ€ï¼š</view>
            <view class="detail-value">
              <view class="status-badge {{getStatusClass(currentContract.status)}}">
                {{getStatusText(currentContract.status)}}
              </view>
            </view>
          </view>
        </view>

        <view class="detail-section">
          <view class="section-title">æ—¶é—´ä¿¡æ¯</view>
          <view class="detail-row">
            <view class="detail-label">åˆ›å»ºæ—¶é—´ï¼š</view>
            <view class="detail-value">{{formatDate(currentContract.createdAt)}}</view>
          </view>
          <view class="detail-row" wx:if="{{currentContract.issueTime}}">
            <view class="detail-label">ä¸‹å‘æ—¶é—´ï¼š</view>
            <view class="detail-value">{{formatDate(currentContract.issueTime)}}</view>
          </view>
          <view class="detail-row" wx:if="{{currentContract.employeeSignTime}}">
            <view class="detail-label">å‘˜å·¥ç­¾ç½²æ—¶é—´ï¼š</view>
            <view class="detail-value">{{formatDate(currentContract.employeeSignTime)}}</view>
          </view>
          <view class="detail-row" wx:if="{{currentContract.effectiveTime}}">
            <view class="detail-label">åˆåŒç”Ÿæ•ˆæ—¶é—´ï¼š</view>
            <view class="detail-value">{{formatDate(currentContract.effectiveTime)}}</view>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-secondary" bindtap="viewPdf" wx:if="{{currentContract.contractPdfUrl}}">
          é¢„è§ˆPDF
        </button>
        <button class="btn-download" bindtap="downloadPdf" wx:if="{{currentContract.status === 2 && currentContract.contractPdfUrl}}">
          ä¸‹è½½PDF
        </button>
        <button class="btn-primary btn-sign" bindtap="openSignModal" wx:if="{{currentContract.status === 1}}">
          ç«‹å³ç­¾ç½²
        </button>
      </view>
    </view>
  </view>

  <!-- ç­¾åå¼¹çª— -->
  <view class="modal" wx:if="{{showSignModal}}">
    <view class="modal-mask" catchtouchmove="preventTouchMove" bindtap="closeSignModal"></view>
    <view class="modal-content" catchtouchmove="preventTouchMove">
      <view class="modal-header">
        <view class="modal-title">ç”µå­ç­¾å</view>
        <view class="modal-close" bindtap="closeSignModal">âœ•</view>
      </view>

      <view class="modal-body">
        <view class="sign-hint">è¯·åœ¨ä¸‹æ–¹åŒºåŸŸå†…ç­¾åï¼š</view>
        <view class="canvas-container" catchtouchmove>
          <canvas 
            canvas-id="signCanvas" 
            class="sign-canvas"
            bindtouchstart="touchStart"
            bindtouchmove="touchMove"
            bindtouchend="touchEnd"
            disable-scroll="true"
            style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
          ></canvas>
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-secondary" bindtap="clearSignature">æ¸…ç©º</button>
        <button class="btn-primary" bindtap="confirmSignature">ç¡®è®¤ç­¾å</button>
      </view>
    </view>
  </view>
</view>
