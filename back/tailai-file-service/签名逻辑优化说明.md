# File-Service 签名逻辑优化说明

## 更新日期
2025-10-21

## 优化内容

### 1. 签名位置优化 ✅

**新流程签名位置规则**:

| 签名角色 | 位置 | X坐标 | Y坐标 | 说明 |
|---------|------|-------|-------|------|
| MANAGER/经理 | 左下角 | 50 | 50 | 经理先签署 |
| EMPLOYEE/员工 | 右下角 | pageWidth-170 | 50 | 员工后签署 |

**代码位置**: `SignatureService.addSignatureImageToPdf()`

**优化点**:
- ✅ 支持MANAGER和EMPLOYEE角色识别
- ✅ 兼容旧的"员工"、"领导"中文角色
- ✅ 签名位置自动计算（根据PDF页面宽度）
- ✅ 详细的日志记录

### 2. PDF保存路径优化 ✅

**新流程文件保存规则**:

| 签名角色 | 目录 | 文件命名 | 说明 |
|---------|------|---------|------|
| MANAGER | temp-contracts/ | {员工姓名}_待签合同.pdf | 临时文件，待员工签署 |
| EMPLOYEE | effective-contracts/ | {员工姓名}_劳动合同.pdf | 正式文件，合同已生效 |

**代码位置**: `SignatureService.uploadSignedPdfToOss()`

**优化点**:
- ✅ 经理签名后保存到临时目录
- ✅ 员工签名后保存到正式目录
- ✅ 文件命名规范统一
- ✅ 清晰的日志输出

### 3. 签名流程说明

#### 经理签署流程
```
1. 经理在PC端签署
2. 签名叠加到PDF左下角
3. 保存到 temp-contracts/张三_待签合同.pdf
4. 下发给员工
```

#### 员工签署流程
```
1. 员工在小程序签署
2. 从temp-contracts下载经理已签的PDF
3. 签名叠加到PDF右下角（经理签名保留）
4. 保存到 effective-contracts/张三_劳动合同.pdf
5. 合同立即生效
```

### 4. OSS目录结构

```
tailai-contracts（Bucket）
├── templates/              # 合同模板
├── temp-contracts/         # 临时合同（经理已签，待员工签）
│   └── {员工姓名}_待签合同.pdf
├── effective-contracts/    # 已生效合同（双方已签）
│   └── {员工姓名}_劳动合同.pdf
├── certificates/           # 证件照片
└── return-items/          # 物品归还照片
```

---

## 代码改动详情

### 修改文件
- `SignatureService.java`

### 修改方法

#### 1. addSignatureImageToPdf()
**改动**:
```java
// 旧代码
if ("员工".equals(signerRole)) {
    // 员工签名在右下角
} else {
    // 领导签名在左下角
}

// 新代码
if ("EMPLOYEE".equals(signerRole) || "员工".equals(signerRole)) {
    // 员工签名在右下角
} else if ("MANAGER".equals(signerRole) || "经理".equals(signerRole) || "领导".equals(signerRole)) {
    // 经理/领导签名在左下角
} else {
    // 默认位置
}
```

**改进**:
- ✅ 支持新的角色枚举（MANAGER, EMPLOYEE）
- ✅ 兼容旧的中文角色
- ✅ 增加默认处理逻辑

#### 2. uploadSignedPdfToOss()
**改动**:
```java
// 旧代码
String directory = "员工".equals(signerRole) ? "application" : "effective-contracts";

// 新代码
if ("EMPLOYEE".equals(signerRole) || "员工".equals(signerRole)) {
    directory = "effective-contracts";  // 员工签名后合同生效
    newFileName = employeeName + "_劳动合同.pdf";
} else if ("MANAGER".equals(signerRole) || "经理".equals(signerRole)) {
    directory = "temp-contracts";  // 经理签名后待员工签
    newFileName = employeeName + "_待签合同.pdf";
}
```

**改进**:
- ✅ 根据签名角色选择不同目录
- ✅ 文件命名更规范
- ✅ 符合新业务流程

---

## 测试建议

### 单元测试
```java
// 测试经理签名
SignatureRequest managerRequest = new SignatureRequest();
managerRequest.setSignerRole("MANAGER");
managerRequest.setEmployeeName("张三");
// 预期：保存到 temp-contracts/张三_待签合同.pdf

// 测试员工签名
SignatureRequest employeeRequest = new SignatureRequest();
employeeRequest.setSignerRole("EMPLOYEE");
employeeRequest.setEmployeeName("张三");
// 预期：保存到 effective-contracts/张三_劳动合同.pdf
```

### 集成测试
1. 经理发起合同并签署
2. 检查PDF是否保存到temp-contracts目录
3. 员工签署
4. 检查PDF是否保存到effective-contracts目录
5. 检查PDF包含双方签名

---

## 兼容性说明

### 向后兼容
- ✅ 仍支持旧的中文角色（"员工"、"领导"）
- ✅ 旧的PDF路径仍可访问
- ✅ 不影响历史数据

### 注意事项
- ⚠️ 确保OSS Bucket已创建temp-contracts和effective-contracts目录
- ⚠️ 确保OSS有写权限
- ⚠️ 临时目录需要定期清理（建议设置7天生命周期）

---

**优化版本**: v2.0  
**负责人**: 开发团队  
**状态**: ✅ 已完成

