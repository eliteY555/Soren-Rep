"use strict";(self["webpackChunkzhenyitong_online_medical"]=self["webpackChunkzhenyitong_online_medical"]||[]).push([[97],{5097:function(t,e,r){r.r(e),r.d(e,{default:function(){return h}});var o=function(){var t=this,e=t._self._c;return e("div",{staticClass:"communicate-container"},[e("el-card",{staticClass:"communicate-card"},[e("div",{staticClass:"card-header"},[e("div",{staticClass:"header-left"},[e("h2",[t._v("医患交流")]),e("div",{staticClass:"header-decoration"},[e("span",{staticClass:"decoration-line"}),e("span",{staticClass:"decoration-dot"})])]),e("div",{staticClass:"decorative-icon"},[e("img",{staticClass:"decorative-pattern",attrs:{src:r(4305),alt:"装饰图案"}})])]),e("div",{staticClass:"communicate-content"},[t.loading?e("div",{staticClass:"loading-container"},[e("el-skeleton",{attrs:{rows:3,animated:""}}),e("el-skeleton",{staticStyle:{"margin-top":"20px"},attrs:{rows:3,animated:""}})],1):0===t.filteredCommentList.length?e("div",{staticClass:"empty-container"},[e("el-empty",{attrs:{description:"暂无评论信息"},scopedSlots:t._u([{key:"image",fn:function(){return[e("i",{staticClass:"el-icon-chat-line-round empty-icon"})]},proxy:!0}])})],1):e("div",{staticClass:"comment-list"},t._l(t.filteredCommentList,(function(r){return e("div",{key:r.commentId,staticClass:"comment-card",on:{click:function(e){return t.goRecordDetail(r.recordId)}}},[e("div",{staticClass:"comment-header"},[e("div",{staticClass:"user-info"},[e("i",{staticClass:"el-icon-user"}),e("span",{staticClass:"username"},[t._v(t._s(r.username))]),e("el-tag",{attrs:{size:"mini",type:"info"}},[t._v("患者")])],1),e("div",{staticClass:"comment-date"},[t._v(t._s(t.formatDate(r.createTime)))])]),e("div",{staticClass:"comment-content"},[e("i",{staticClass:"el-icon-chat-dot-square"}),e("div",{staticClass:"content-text"},[t._v(t._s(r.content))])]),e("div",{staticClass:"case-info"},[e("i",{staticClass:"el-icon-document-copy"}),e("div",{staticClass:"case-description"},[e("span",{staticClass:"label"},[t._v("病情描述：")]),e("span",{staticClass:"text"},[t._v(t._s(r.record?r.record.description:""))])])]),e("div",{staticClass:"comment-footer"},[e("el-button",{staticClass:"view-detail",attrs:{type:"text"}},[e("i",{staticClass:"el-icon-view"}),t._v(" 查看详情 ")]),e("el-button",{staticClass:"reply-button",attrs:{type:"text"}},[e("i",{staticClass:"el-icon-s-comment"}),t._v(" 回复 ")])],1)])})),0)])]),t._m(0)],1)},n=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"floating-patterns"},[e("div",{staticClass:"floating-pattern pattern1"}),e("div",{staticClass:"floating-pattern pattern2"}),e("div",{staticClass:"floating-pattern pattern3"})])}],s=(r(4114),r(8992),r(4520),r(1454),r(1009)),i=r(8443),a=r(7909),c=r(5720),u={components:{},data(){return{filteredCommentList:[],loading:!1,doctorInfo:null,isComponentMounted:!1}},computed:{userInfo(){return this.$store.state.user.userInfo}},async created(){this.loading=!0},async mounted(){if(this.isComponentMounted=!0,this.userInfo&&this.userInfo.userId)try{await this.loadComments()}catch(t){this.handleError(t)}this.$bus.$on("user-info-loaded",this.onUserInfoLoaded),this.$bus.$on("route-complete",this.onRouteComplete),this.routerGuard=this.$router.beforeEach(((e,r,o)=>{"/home/communicate"===e.path&&r.path.startsWith("/home/")&&this.$nextTick((async()=>{if(this.isComponentMounted&&this.userInfo&&this.userInfo.userId)try{await this.loadComments()}catch(t){this.handleError(t)}})),o()}))},watch:{userInfo:{async handler(t){if(t&&t.userId&&this.isComponentMounted)try{await this.loadComments()}catch(e){this.handleError(e)}},immediate:!0}},beforeDestroy(){this.$bus.$off("user-info-loaded",this.onUserInfoLoaded),this.$bus.$off("route-complete",this.onRouteComplete),this.routerGuard&&"function"===typeof this.routerGuard&&this.routerGuard(),(0,c.Ks)(),this.isComponentMounted=!1},activated(){this.isComponentMounted&&this.userInfo&&this.userInfo.userId&&this.$nextTick((async()=>{try{await this.loadComments()}catch(t){this.handleError(t)}}))},methods:{formatDate(t){return t?t.split("T")[0]:""},handleError(t){(0,c.tq)(t)?console.log("请求已被取消，这是正常行为"):(console.error("加载评论失败:",t),this.$message.error("加载评论失败，请稍后再试"))},async loadComments(){if(this.isComponentMounted){this.loading=!0;try{if(!this.userInfo||!this.userInfo.userId)return void this.$message.warning("用户信息未加载，请重新登录");if((!this.doctorInfo||!this.doctorInfo.doctorId)&&(this.doctorInfo=await(0,a.Q9)(this.userInfo.userId),!this.doctorInfo||!this.doctorInfo.doctorId))return void this.$message.warning("未找到医生信息");const t=await(0,s.SY)(),e=t.map((async t=>{try{const e=await(0,i.se)(t.recordId);return e.doctorId===this.doctorInfo.doctorId?{...t,record:e}:null}catch(e){return(0,c.tq)(e)||console.error(`获取记录 ${t.recordId} 失败:`,e),null}})),r=await Promise.all(e);this.filteredCommentList=r.filter((t=>null!==t))}finally{this.isComponentMounted&&(this.loading=!1)}}},goRecordDetail(t){(0,c.Ks)(),this.$nextTick((()=>{localStorage.setItem("recordId",t),this.$router.push({path:"/home/recordDetail"})}))},async onUserInfoLoaded(t){if(t&&t.userId&&this.isComponentMounted)try{await this.loadComments()}catch(e){this.handleError(e)}},async onRouteComplete(t){if("/home/communicate"===t.to.path&&this.isComponentMounted&&this.userInfo&&this.userInfo.userId)try{await this.loadComments()}catch(e){this.handleError(e)}}}},d=u,l=r(1656),m=(0,l.A)(d,o,n,!1,null,"3fdd1bf3",null),h=m.exports},1009:function(t,e,r){r.d(e,{SY:function(){return s},Tu:function(){return i},eL:function(){return c},p8:function(){return n},wN:function(){return a}});var o=r(5720);function n(t){return(0,o.Ay)({url:"/comment",method:"post",data:t}).catch((t=>((0,o.tq)(t)||console.error("发布评论失败:",t),Promise.reject(t))))}function s(t){const e=t?{url:`/comment/${t}`,method:"get"}:{url:"/comment",method:"get"};return(0,o.Ay)(e).catch((t=>((0,o.tq)(t)||console.error("获取评论列表失败:",t),Promise.reject(t))))}function i(t){return(0,o.Ay)({url:`/comment/delete/${t}`,method:"get"}).catch((t=>((0,o.tq)(t)||console.error("删除评论失败:",t),Promise.reject(t))))}function a(t){return(0,o.Ay)({url:"/reply",method:"post",data:t}).catch((t=>((0,o.tq)(t)||console.error("回复评论失败:",t),Promise.reject(t))))}function c(t){return(0,o.Ay)({url:`/reply/delete/${t}`,method:"get"}).catch((t=>((0,o.tq)(t)||console.error("删除回复失败:",t),Promise.reject(t))))}},7909:function(t,e,r){r.d(e,{BL:function(){return s},Gn:function(){return c},Q9:function(){return i},QQ:function(){return u},a2:function(){return a}});r(1454);var o=r(5720);const n={info:new Map,list:null,timestamp:0,EXPIRY:6e5,isExpired(){return Date.now()-this.timestamp>this.EXPIRY},reset(){this.info.clear(),this.list=null,this.timestamp=0}};function s(t){return n.reset(),(0,o.Ay)({url:"/doctor/update",method:"post",data:t}).catch((t=>((0,o.tq)(t)||console.error("更新医生信息失败:",t),Promise.reject(t))))}function i(t){return t?n.info.has(t)&&!n.isExpired()?(console.log(`使用缓存的医生信息 (userId: ${t})`),Promise.resolve(n.info.get(t))):(console.log(`从服务器获取医生信息 (userId: ${t})...`),(0,o.Ay)({url:`/doctor/get/${t}`,method:"get",retryTimes:3,timeout:15e3,headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"},params:{_t:(new Date).getTime()}}).then((e=>(e?(console.log(`成功获取医生信息 (userId: ${t}):`,e),n.info.set(t,e),n.timestamp=Date.now()):console.warn(`医生信息返回空数据 (userId: ${t})`),e))).catch((e=>(0,o.tq)(e)?(console.log(`获取医生信息请求被取消 (userId: ${t})`),Promise.reject(e)):(console.error(`获取医生信息(ID: ${t})失败:`,e),Promise.reject(e))))):Promise.reject(new Error("用户ID不能为空"))}function a(t=2){return console.log("正在获取所有医生列表..."),n.reset(),(0,o.Ay)({url:"/doctor",method:"get",retryTimes:t,headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"},params:{_t:(new Date).getTime()}}).then((t=>(t?(console.log(`成功获取${t.length||0}条医生数据`),t.length>0&&console.log("医生列表预览:",t.map((t=>({id:t.doctorId,name:t.doctorName,hospital:t.hospitalName,department:t.departmentName}))))):console.warn("获取医生列表返回空数据"),t))).catch((t=>(0,o.tq)(t)?(console.log("医生列表请求被取消"),Promise.reject(t)):"CanceledError"===t.name||"ERR_CANCELED"===t.code?(console.log("医生列表请求被取消 (CanceledError)"),Promise.reject(t)):(console.error("获取医生列表失败:",t),Promise.reject(t))))}function c(t){return(0,o.Ay)({url:"/doctor/page",method:"post",data:t}).catch((t=>((0,o.tq)(t)||console.error("分页获取医生列表失败:",t),Promise.reject(t))))}function u(t){return n.reset(),(0,o.Ay)({url:"/doctor/create",method:"post",data:t}).catch((t=>((0,o.tq)(t)||console.error("创建医生信息失败:",t),Promise.reject(t))))}},8443:function(t,e,r){r.d(e,{$1:function(){return s},EF:function(){return u},a1:function(){return i},se:function(){return a},vL:function(){return c}});var o=r(5720);const n={info:new Map,timestamp:0,EXPIRY:3e5,isExpired(){return Date.now()-this.timestamp>this.EXPIRY},reset(){this.info.clear(),this.timestamp=0}};function s(t){return n.reset(),(0,o.Ay)({url:"/record/add",method:"post",data:t}).catch((t=>((0,o.tq)(t)||console.error("添加病历失败:",t),Promise.reject(t))))}function i(t){return(0,o.Ay)({url:"/record/page",method:"post",data:t}).catch((t=>((0,o.tq)(t)||console.error("获取病历列表失败:",t),Promise.reject(t))))}function a(t){return t?n.info.has(t)&&!n.isExpired()?Promise.resolve(n.info.get(t)):(0,o.Ay)({url:`/record/${t}`,method:"get",retryTimes:2,retryDelay:1e3,timeout:1e4}).then((e=>(e&&(n.info.set(t,e),n.timestamp=Date.now()),e))).catch((e=>((0,o.tq)(e)||(console.error(`获取病历 ${t} 失败:`,e),n.info.delete(t)),Promise.reject(e)))):Promise.reject(new Error("记录ID不能为空"))}function c(t){return t&&t.recordId?n.info.delete(t.recordId):n.reset(),(0,o.Ay)({url:"/record/update",method:"post",data:t}).catch((t=>((0,o.tq)(t)||console.error("更新病历失败:",t),Promise.reject(t))))}function u(t,e=5){return(0,o.Ay)({url:"/record/recommend",method:"post",data:{diagnosisText:t,limit:e}}).catch((t=>((0,o.tq)(t)||console.error("获取诊断推荐失败:",t),Promise.reject(t))))}},4305:function(t,e,r){t.exports=r.p+"static/img/geometric-pattern.13c22a87.svg"},6319:function(t,e,r){var o=r(8551),n=r(9539);t.exports=function(t,e,r,s){try{return s?e(o(r)[0],r[1]):e(r)}catch(i){n(t,"throw",i)}}},2529:function(t){t.exports=function(t,e){return{value:t,done:e}}},6279:function(t,e,r){var o=r(6840);t.exports=function(t,e,r){for(var n in e)o(t,n,e[n],r);return t}},9462:function(t,e,r){var o=r(9565),n=r(2360),s=r(6699),i=r(6279),a=r(8227),c=r(1181),u=r(5966),d=r(7657).IteratorPrototype,l=r(2529),m=r(9539),h=a("toStringTag"),f="IteratorHelper",p="WrapForValidIterator",C=c.set,v=function(t){var e=c.getterFor(t?p:f);return i(n(d),{next:function(){var r=e(this);if(t)return r.nextHandler();if(r.done)return l(void 0,!0);try{var o=r.nextHandler();return r.returnHandlerResult?o:l(o,r.done)}catch(n){throw r.done=!0,n}},return:function(){var r=e(this),n=r.iterator;if(r.done=!0,t){var s=u(n,"return");return s?o(s,n):l(void 0,!0)}if(r.inner)try{m(r.inner.iterator,"normal")}catch(i){return m(n,"throw",i)}return n&&m(n,"normal"),l(void 0,!0)}})},I=v(!0),g=v(!1);s(g,h,"Iterator Helper"),t.exports=function(t,e,r){var o=function(o,n){n?(n.iterator=o.iterator,n.next=o.next):n=o,n.type=e?p:f,n.returnHandlerResult=!!r,n.nextHandler=t,n.counter=0,n.done=!1,C(this,n)};return o.prototype=e?I:g,o}},713:function(t,e,r){var o=r(9565),n=r(9306),s=r(8551),i=r(1767),a=r(9462),c=r(6319),u=a((function(){var t=this.iterator,e=s(o(this.next,t)),r=this.done=!!e.done;if(!r)return c(t,this.mapper,[e.value,this.counter++],!0)}));t.exports=function(t){return s(this),n(t),new u(i(this),{mapper:t})}},2489:function(t,e,r){var o=r(6518),n=r(9565),s=r(9306),i=r(8551),a=r(1767),c=r(9462),u=r(6319),d=r(6395),l=c((function(){var t,e,r,o=this.iterator,s=this.predicate,a=this.next;while(1){if(t=i(n(a,o)),e=this.done=!!t.done,e)return;if(r=t.value,u(o,s,[r,this.counter++],!0))return r}}));o({target:"Iterator",proto:!0,real:!0,forced:d},{filter:function(t){return i(this),s(t),new l(a(this),{predicate:t})}})},1701:function(t,e,r){var o=r(6518),n=r(713),s=r(6395);o({target:"Iterator",proto:!0,real:!0,forced:s},{map:n})},4520:function(t,e,r){r(2489)},1454:function(t,e,r){r(1701)}}]);