"use strict";(self["webpackChunkzhenyitong_online_medical"]=self["webpackChunkzhenyitong_online_medical"]||[]).push([[133],{8133:function(e,t,r){r.r(t),r.d(t,{default:function(){return w}});var s=function(){var e=this,t=e._self._c;return t("div",{staticClass:"diagnosis-container"},[t("el-card",{staticClass:"diagnosis-card"},[t("div",{staticClass:"card-header"},[t("div",{staticClass:"header-left"},[t("h2",[e._v("诊断管理")]),t("div",{staticClass:"header-decoration"},[t("span",{staticClass:"decoration-line"}),t("span",{staticClass:"decoration-dot"})])]),t("div",{staticClass:"decorative-icon"},[t("img",{staticClass:"decorative-pattern",attrs:{src:r(4305),alt:"装饰图案"}})])]),t("el-tabs",{staticClass:"diagnosis-tabs",model:{value:e.activeName,callback:function(t){e.activeName=t},expression:"activeName"}},[t("el-tab-pane",{attrs:{label:"全部病历",name:"all"}},["all"===e.activeName?t("all",{attrs:{activeName:e.activeName},on:{"update-undiagnosed":e.updateUndiagnosedStatus}}):e._e()],1),t("el-tab-pane",{attrs:{name:"noDiagnosis"}},[t("span",{attrs:{slot:"label"},slot:"label"},[t("el-badge",{attrs:{"is-dot":e.hasUndiagnosedRecords}},[e._v("未诊断病历")])],1),"noDiagnosis"===e.activeName?t("all",{attrs:{activeName:e.activeName},on:{"update-undiagnosed":e.updateUndiagnosedStatus}}):e._e()],1)],1)],1),e._m(0)],1)},o=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"floating-patterns"},[t("div",{staticClass:"floating-pattern pattern1"}),t("div",{staticClass:"floating-pattern pattern2"}),t("div",{staticClass:"floating-pattern pattern3"})])}],n=(r(4114),r(8992),r(2577),function(){var e=this,t=e._self._c;return t("div",{staticStyle:{height:"100%",width:"100%",display:"flex","flex-direction":"column",overflow:"hidden"}},[t("div",{staticClass:"filter-container"},[t("el-input",{staticClass:"filter-item",attrs:{placeholder:"请输入患者姓名/手机号"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleQuery.apply(null,arguments)}},model:{value:e.form.keyword,callback:function(t){e.$set(e.form,"keyword",t)},expression:"form.keyword"}},[t("i",{staticClass:"el-icon-search",attrs:{slot:"prefix"},slot:"prefix"})]),t("el-button",{staticClass:"filter-button",attrs:{type:"primary",icon:"el-icon-search"},on:{click:e.handleQuery}},[e._v(" 查询 ")]),t("el-button",{staticClass:"filter-button",attrs:{icon:"el-icon-refresh"},on:{click:e.resetQuery}},[e._v(" 重置 ")])],1),t("div",{staticClass:"table-container"},[t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"medical-table",attrs:{data:e.recordList,border:"","header-cell-style":{background:"var(--ginseng-beige)",color:"var(--rhubarb-brown)",fontWeight:"600"},"row-class-name":e.tableRowClassName,size:"mini"}},[t("el-table-column",{attrs:{label:"患者信息",align:"center","min-width":"180"},scopedSlots:e._u([{key:"default",fn:function(r){return[t("div",{staticClass:"patient-info"},[t("div",{staticClass:"patient-name"},[t("i",{staticClass:"el-icon-user"}),t("span",[e._v(e._s(r.row.patientName))])]),t("div",{staticClass:"patient-details"},[t("span",[t("i",{staticClass:"el-icon-mobile-phone"}),e._v(" "+e._s(r.row.phone))]),t("span",[t("i",{staticClass:"el-icon-time"}),e._v(" "+e._s(r.row.age)+"岁")])])])]}}])}),t("el-table-column",{attrs:{label:"病症详情",prop:"description","min-width":"280"},scopedSlots:e._u([{key:"default",fn:function(r){return[t("div",{staticClass:"symptom-info"},[t("i",{staticClass:"el-icon-tickets"}),r.row.description&&r.row.description.length>50?t("el-tooltip",{attrs:{content:r.row.description,placement:"top"}},[t("span",{staticClass:"text-ellipsis"},[e._v(e._s(r.row.description))])]):t("span",{staticClass:"text-ellipsis"},[e._v(e._s(r.row.description||"暂无详情"))])],1)]}}])}),t("el-table-column",{attrs:{label:"状态",align:"center",width:"100"},scopedSlots:e._u([{key:"default",fn:function(r){return[0==r.row.status?t("el-tag",{attrs:{size:"mini",type:"info"}},[e._v("未查看")]):1==r.row.status?t("el-tag",{attrs:{size:"mini",type:"warning"}},[e._v("已查看")]):2==r.row.status?t("el-tag",{attrs:{size:"mini",type:"success"}},[e._v("已诊断")]):3==r.row.status?t("el-tag",{attrs:{size:"mini",type:"danger"}},[e._v("诊断已结束")]):e._e()]}}])}),t("el-table-column",{attrs:{label:"操作",align:"center",width:"100"},scopedSlots:e._u([{key:"default",fn:function(r){return[t("el-button",{staticClass:"operation-button",attrs:{type:"text"},on:{click:function(t){return e.goRecordDetail(r.row)}}},[t("i",{staticClass:"el-icon-view"}),e._v(" 查看详情 ")])]}}])})],1),0===e.recordList.length?t("div",{staticClass:"empty-data"},[t("i",{staticClass:"el-icon-document"}),t("p",[e._v("暂无病历数据")])]):e._e()],1),t("div",{staticClass:"pagination"},[t("el-pagination",{attrs:{background:"",layout:"total, sizes, prev, pager, next, jumper","page-sizes":[10,20,30,50],"current-page":e.tableParams.page,"page-size":e.tableParams.pageSize,total:e.total},on:{"current-change":t=>e.handleQuery({page:t}),"size-change":t=>e.handleQuery({pageSize:t})}})],1)])}),a=[],i=r(8443),l=r(7909),c=r(5720),d={name:"all",components:{},props:["activeName"],data(){return{recordList:[],tableParams:{page:1,pageSize:10},total:0,form:{keyword:"",pageNum:1,pageSize:10},loading:!1,windowWidth:window.innerWidth}},computed:{userInfo(){return this.$store.state.user.userInfo}},mounted(){this.userInfo&&this.userInfo.userId&&this.handleQuery(),this.$bus.$on("user-info-loaded",this.onUserInfoLoaded),this.$bus.$on("refresh-diagnosis-list",this.refreshData),window.addEventListener("resize",this.handleResize),this.handleResize()},beforeDestroy(){this.$bus.$off("user-info-loaded",this.onUserInfoLoaded),this.$bus.$off("refresh-diagnosis-list",this.refreshData),window.removeEventListener("resize",this.handleResize),(0,c.Ks)()},watch:{userInfo:{handler(e){e&&e.userId&&this.handleQuery()},immediate:!0},activeName:{handler(e,t){this.tableParams.status="noDiagnosis"===e?"0,1":"",this.userInfo&&this.userInfo.userId&&this.handleQuery()},immediate:!0}},methods:{handleResize(){this.windowWidth=window.innerWidth},tableRowClassName({row:e,rowIndex:t}){return 0===e.status?"unread-row":1===e.status?"viewed-row":""},async handleQuery(e={}){this.loading=!0;try{if(!this.userInfo||1!==this.userInfo.role)return this.recordList=[],void(this.total=0);const t=await(0,l.Q9)(this.userInfo.userId);if(!t||!t.doctorId)return this.recordList=[],void(this.total=0);this.tableParams={...this.tableParams,...e,doctorId:t.doctorId};const r=await(0,i.a1)(this.tableParams);if(this.recordList=r.recordList||[],this.total=r.total||0,"all"===this.activeName){const e={doctorId:t.doctorId,status:"0,1",page:1,pageSize:1},r=await(0,i.a1)(e);this.$emit("update-undiagnosed",(r.total||0)>0)}}catch(t){if((0,c.tq)(t))return;console.error("获取诊断列表失败:",t),this.$message.error("获取诊断列表失败，请稍后再试"),this.recordList=[],this.total=0}finally{this.loading=!1}},goRecordDetail(e){(0,c.Ks)(),this.$nextTick((()=>{this.$router.push({path:"/diagnosis/detail",query:{recordId:e.recordId}})}))},onUserInfoLoaded(e){e&&e.userId&&this.handleQuery()},refreshData(){this.userInfo&&this.userInfo.userId&&this.handleQuery()},resetQuery(){this.form.keyword="",this.tableParams.page=1,this.handleQuery()}}},u=d,h=r(1656),f=(0,h.A)(u,n,a,!1,null,"5e16e5eb",null),m=f.exports,p={components:{all:m},data(){return{activeName:"all",hasUndiagnosedRecords:!1}},computed:{userInfo(){return this.$store.state.user.userInfo}},mounted(){this.userInfo&&this.userInfo.userId&&this.initData(),this.$bus.$on("user-info-loaded",this.onUserInfoLoaded),this.$bus.$on("refresh-diagnosis-list",this.refreshList)},beforeDestroy(){this.$bus.$off("user-info-loaded",this.onUserInfoLoaded),this.$bus.$off("refresh-diagnosis-list",this.refreshList),(0,c.Ks)()},watch:{userInfo:{handler(e){e&&e.userId&&this.initData()},immediate:!0}},methods:{async initData(){if(!this.userInfo||1!==this.userInfo.role)return this.$message.warning("当前用户不是医师角色，无法使用诊断功能"),void setTimeout((()=>{this.$router.push("/home")}),1500);try{const e=await this.getDoctorInfo();if(!e)return void this.$message.warning("获取医师信息失败，请稍后再试");if(!e.doctorId||!e.doctorName||!e.departmentName||!e.hospitalName)return void this.$message.warning("医师信息不完整，请联系管理员完善您的医师资料");await this.handleQuery()}catch(e){if(e&&("CanceledError"===e.name||"RequestCancelError"===e.name||"ERR_CANCELED"===e.code))return;console.error("初始化诊断列表失败:",e),this.$message.error("加载诊断数据失败，请稍后再试")}},async getDoctorInfo(){let e=0;const t=3;if((!this.userInfo||!this.userInfo.userId)&&(console.log("等待用户信息加载..."),await new Promise((e=>setTimeout(e,300))),!this.userInfo||!this.userInfo.userId))return console.log("用户ID仍不存在，无法获取医师信息"),null;const r=async()=>{try{console.log(`尝试获取医师信息 (userId: ${this.userInfo.userId}), 尝试次数: ${e+1}`),await new Promise((t=>setTimeout(t,100*e)));const t=await(0,l.Q9)(this.userInfo.userId);if(!t)throw new Error("医师信息为空");return console.log("成功获取到医师信息:",t),t}catch(s){if((0,c.tq)(s))return console.log("获取医师信息请求被取消，可能是由于页面切换"),null;if(console.error(`获取医师信息失败 (尝试 ${e+1}/${t}):`,s),e<t-1){e++;const s=1e3*Math.pow(1.5,e);return console.log(`等待${s/1e3}秒后重试... (${e}/${t-1})`),await new Promise((e=>setTimeout(e,s))),r()}return null}};return r()},handleQuery:(0,c.sg)((async function(e={}){try{console.log("开始查询诊断列表...");const e=await this.getDoctorInfo();if(!e||!e.doctorId)return void console.error("无法获取医生ID，无法查询诊断列表");this.$nextTick((()=>{const e=this.$children.find((e=>"all"===e.$options.name));e&&"function"===typeof e.handleQuery?(console.log("通知子组件刷新数据..."),e.handleQuery()):console.warn("未找到子组件或刷新方法")}))}catch(t){if((0,c.tq)(t))return void console.log("查询请求被取消");console.error("获取诊断列表失败:",t),this.$message.error("获取诊断列表失败，请稍后再试")}}),300),updateUndiagnosedStatus(e){this.hasUndiagnosedRecords=e},refreshList(){this.userInfo&&this.userInfo.userId&&this.initData()},onUserInfoLoaded(e){e&&e.userId&&setTimeout((()=>{console.log("用户信息已加载，开始初始化数据..."),this.initData()}),300)}}},g=p,v=(0,h.A)(g,s,o,!1,null,"727605bb",null),w=v.exports},7909:function(e,t,r){r.d(t,{BL:function(){return n},Gn:function(){return l},Q9:function(){return a},QQ:function(){return c},a2:function(){return i}});r(1454);var s=r(5720);const o={info:new Map,list:null,timestamp:0,EXPIRY:6e5,isExpired(){return Date.now()-this.timestamp>this.EXPIRY},reset(){this.info.clear(),this.list=null,this.timestamp=0}};function n(e){return o.reset(),(0,s.Ay)({url:"/doctor/update",method:"post",data:e}).catch((e=>((0,s.tq)(e)||console.error("更新医生信息失败:",e),Promise.reject(e))))}function a(e){return e?o.info.has(e)&&!o.isExpired()?(console.log(`使用缓存的医生信息 (userId: ${e})`),Promise.resolve(o.info.get(e))):(console.log(`从服务器获取医生信息 (userId: ${e})...`),(0,s.Ay)({url:`/doctor/get/${e}`,method:"get",retryTimes:3,timeout:15e3,headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"},params:{_t:(new Date).getTime()}}).then((t=>(t?(console.log(`成功获取医生信息 (userId: ${e}):`,t),o.info.set(e,t),o.timestamp=Date.now()):console.warn(`医生信息返回空数据 (userId: ${e})`),t))).catch((t=>(0,s.tq)(t)?(console.log(`获取医生信息请求被取消 (userId: ${e})`),Promise.reject(t)):(console.error(`获取医生信息(ID: ${e})失败:`,t),Promise.reject(t))))):Promise.reject(new Error("用户ID不能为空"))}function i(e=2){return console.log("正在获取所有医生列表..."),o.reset(),(0,s.Ay)({url:"/doctor",method:"get",retryTimes:e,headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"},params:{_t:(new Date).getTime()}}).then((e=>(e?(console.log(`成功获取${e.length||0}条医生数据`),e.length>0&&console.log("医生列表预览:",e.map((e=>({id:e.doctorId,name:e.doctorName,hospital:e.hospitalName,department:e.departmentName}))))):console.warn("获取医生列表返回空数据"),e))).catch((e=>(0,s.tq)(e)?(console.log("医生列表请求被取消"),Promise.reject(e)):"CanceledError"===e.name||"ERR_CANCELED"===e.code?(console.log("医生列表请求被取消 (CanceledError)"),Promise.reject(e)):(console.error("获取医生列表失败:",e),Promise.reject(e))))}function l(e){return(0,s.Ay)({url:"/doctor/page",method:"post",data:e}).catch((e=>((0,s.tq)(e)||console.error("分页获取医生列表失败:",e),Promise.reject(e))))}function c(e){return o.reset(),(0,s.Ay)({url:"/doctor/create",method:"post",data:e}).catch((e=>((0,s.tq)(e)||console.error("创建医生信息失败:",e),Promise.reject(e))))}},8443:function(e,t,r){r.d(t,{$1:function(){return n},EF:function(){return c},a1:function(){return a},se:function(){return i},vL:function(){return l}});var s=r(5720);const o={info:new Map,timestamp:0,EXPIRY:3e5,isExpired(){return Date.now()-this.timestamp>this.EXPIRY},reset(){this.info.clear(),this.timestamp=0}};function n(e){return o.reset(),(0,s.Ay)({url:"/record/add",method:"post",data:e}).catch((e=>((0,s.tq)(e)||console.error("添加病历失败:",e),Promise.reject(e))))}function a(e){return(0,s.Ay)({url:"/record/page",method:"post",data:e}).catch((e=>((0,s.tq)(e)||console.error("获取病历列表失败:",e),Promise.reject(e))))}function i(e){return e?o.info.has(e)&&!o.isExpired()?Promise.resolve(o.info.get(e)):(0,s.Ay)({url:`/record/${e}`,method:"get",retryTimes:2,retryDelay:1e3,timeout:1e4}).then((t=>(t&&(o.info.set(e,t),o.timestamp=Date.now()),t))).catch((t=>((0,s.tq)(t)||(console.error(`获取病历 ${e} 失败:`,t),o.info.delete(e)),Promise.reject(t)))):Promise.reject(new Error("记录ID不能为空"))}function l(e){return e&&e.recordId?o.info.delete(e.recordId):o.reset(),(0,s.Ay)({url:"/record/update",method:"post",data:e}).catch((e=>((0,s.tq)(e)||console.error("更新病历失败:",e),Promise.reject(e))))}function c(e,t=5){return(0,s.Ay)({url:"/record/recommend",method:"post",data:{diagnosisText:e,limit:t}}).catch((e=>((0,s.tq)(e)||console.error("获取诊断推荐失败:",e),Promise.reject(e))))}},4305:function(e,t,r){e.exports=r.p+"static/img/geometric-pattern.13c22a87.svg"},6319:function(e,t,r){var s=r(8551),o=r(9539);e.exports=function(e,t,r,n){try{return n?t(s(r)[0],r[1]):t(r)}catch(a){o(e,"throw",a)}}},2529:function(e){e.exports=function(e,t){return{value:e,done:t}}},6279:function(e,t,r){var s=r(6840);e.exports=function(e,t,r){for(var o in t)s(e,o,t[o],r);return e}},9462:function(e,t,r){var s=r(9565),o=r(2360),n=r(6699),a=r(6279),i=r(8227),l=r(1181),c=r(5966),d=r(7657).IteratorPrototype,u=r(2529),h=r(9539),f=i("toStringTag"),m="IteratorHelper",p="WrapForValidIterator",g=l.set,v=function(e){var t=l.getterFor(e?p:m);return a(o(d),{next:function(){var r=t(this);if(e)return r.nextHandler();if(r.done)return u(void 0,!0);try{var s=r.nextHandler();return r.returnHandlerResult?s:u(s,r.done)}catch(o){throw r.done=!0,o}},return:function(){var r=t(this),o=r.iterator;if(r.done=!0,e){var n=c(o,"return");return n?s(n,o):u(void 0,!0)}if(r.inner)try{h(r.inner.iterator,"normal")}catch(a){return h(o,"throw",a)}return o&&h(o,"normal"),u(void 0,!0)}})},w=v(!0),I=v(!1);n(I,f,"Iterator Helper"),e.exports=function(e,t,r){var s=function(s,o){o?(o.iterator=s.iterator,o.next=s.next):o=s,o.type=t?p:m,o.returnHandlerResult=!!r,o.nextHandler=e,o.counter=0,o.done=!1,g(this,o)};return s.prototype=t?w:I,s}},713:function(e,t,r){var s=r(9565),o=r(9306),n=r(8551),a=r(1767),i=r(9462),l=r(6319),c=i((function(){var e=this.iterator,t=n(s(this.next,e)),r=this.done=!!t.done;if(!r)return l(e,this.mapper,[t.value,this.counter++],!0)}));e.exports=function(e){return n(this),o(e),new c(a(this),{mapper:e})}},116:function(e,t,r){var s=r(6518),o=r(2652),n=r(9306),a=r(8551),i=r(1767);s({target:"Iterator",proto:!0,real:!0},{find:function(e){a(this),n(e);var t=i(this),r=0;return o(t,(function(t,s){if(e(t,r++))return s(t)}),{IS_RECORD:!0,INTERRUPTED:!0}).result}})},1701:function(e,t,r){var s=r(6518),o=r(713),n=r(6395);s({target:"Iterator",proto:!0,real:!0,forced:n},{map:o})},2577:function(e,t,r){r(116)},1454:function(e,t,r){r(1701)}}]);